<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Assembling from scratch: Encoding BLX instruction in ARM / THUMB
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!--<link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          CodePwn
        </a>
      </h1>
      <p class="lead">Stuff about Security</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/pank4j">GitHub</a>
    </nav>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Assembling from scratch: Encoding BLX instruction in ARM / THUMB</h1>
  <span class="post-date">19 Oct 2013</span>
  <p><center><img src="/public/images/blx.png" /></center></p>

<p>If you have been working on x86 disassembly and moving on to ARM disassembly, one of the subtle differences you may notice is the lack of byte aligned opcodes in ARM (or THUMB) instruction set. Being based on RISC, ARM architecture provides fewer instructions as compared to x86. The need to implement an instruction set having functionally similar instructions as their x86 counterparts, only using fewer (and perhaps smaller) instructions gave rise to the instructions where opcodes are not dictated by bytes but by bits.</p>

<p>One of such intriguing instructions in ARM is BLX. BLX instruction performs a PC relative unconditional branch, and optionally changes mode to ARM or THUMB depending on the target address. It encodes to a 32-bit word under THUMB mode 2. It&#39;s encoding varies depending upon the relative offset between the instruction and the target address. For e.g. the instruction at 0x2EA6 in the disassembly above encodes to <code>D8 F0 08 E8</code> while another BLX instruction at 0x30C4 encodes to <code>8E F3 C4 E9</code>. The encoded instruction itself is divided into two 16-bit halves, each of which is shown in little-endian. The actual encodings are therefore F0 D8 E8 08 and F3 8E E9 C4. The encoding is explained in the THUMB instruction set (available <a href="https://ece.uwaterloo.ca/%7Eece222/ARM/ARM7-TDMI-manual-pt3.pdf">here</a>).</p>

<p>
<style type="text/css">
.pic {
    display: inline-block;
    margin-left: auto;
    margin-right: 10%;
    /*height: 30px;*/
}

#images {
    text-align:center;
}
</style>
<div id="images">
<img class="pic" src="/public/images/blxasm1.png" /><img class="pic" src="/public/images/blxasm2.png" />
</div>
</p>

<h2>Calculating the offset</h2>

<p>The instruction at 0x2EA6 branches to <code>_obj_msgSend</code>, which is at 0xDAEB8. The offset for encoding is calculated from the current value of PC which is 4 bytes ahead due to pipeline, i.e. 0x2EAA. When the target of branch is 32-bit ARM code, the value used is align(PC, 4), which is PC rounded down to align it to 4 bytes, i.e. PC &amp; 0xFFFFFFFC (0x2EA8 in this case). The offset is therefore, 0xDAEB8 - 0x2EA8 = 0xD8010.<br/></p>

<h2>Encoding the instruction</h2>

<p>The offset is then used to encode the instruction as follows:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Offset = 0xD8010

      00            0D            80            10

Bits 31-24         23-16         15-8           7-0
   0000 0000     0000 1101     1000 0000     0001 0000

Bits 31-25      24 23 22       21-12          11-2         10
     0000000     0  0  0     0011011000     0000000100     00
                 S I1  I2         H              L

J1 = ~I1 ^ S = 1
J2 = ~I2 ^ S = 1

Encoded instruction:

Bits 32-28    27       26-17      16-15 14 13 12     11-1          0
               S          H             J1    J2        L
     11110     0     0011011000     11  1  0  1     0000000100     0

      1111 0000     1101 1000     1110 1000     0000 1000

         F0            D8             E8           08
</code></pre></div>
<p>which explains the encoding seen in the disassembler <code>(D8 F0 08 E8)</code>. :-)</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'codepwn'; // required: replace example with your forum shortname
    var disqus_identifier = '171 /?p=171';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/appminder-jailbreak-detection-analysis">
            AppMinder jailbreak detection analysis
            <small>28 Dec 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/dirty-harry-hacking-for-free-drinks-in-singapore">
            Dirty Harry: Hacking for free drinks in Singapore
            <small>04 Nov 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/posts/exploiting-file-uploads-for-fun-and-profit">
            Exploiting File Uploads for Fun and Profit
            <small>29 Jun 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


    </div>

  </body>
</html>
